name: Deploy Bot to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /root/telegram-bot
          
          # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞
          sudo systemctl stop telegram-bot
          
          # Backup —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
          cp bot.py bot.py.backup.$(date +%Y%m%d_%H%M%S)
          
          # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
          git fetch origin
          git reset --hard origin/main
          
          # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è requirements.txt)
          source venv/bin/activate
          pip install -r requirements.txt --quiet
          
          # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ systemd (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
          sudo systemctl daemon-reload
          
          # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
          sudo systemctl start telegram-bot
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
          sleep 3
          sudo systemctl status telegram-bot --no-pager
          
          echo "‚úÖ Deployment completed!"
    
    - name: Notify on success
      if: success()
      run: echo "üéâ Bot deployed successfully to VPS!"
    
    - name: Notify on failure
      if: failure()
      run: echo "‚ùå Deployment failed. Check logs."
