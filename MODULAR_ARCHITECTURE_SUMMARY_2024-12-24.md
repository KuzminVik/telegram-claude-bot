# –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ + RAG Smart Filtering - Summary v9.0

**–î–∞—Ç–∞:** 24 –¥–µ–∫–∞–±—Ä—è 2024  
**–í–µ—Ä—Å–∏—è:** 9.0.0

---

## üéØ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —É–º–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–ª—è RAG

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù—É–∂–Ω–æ –±—ã–ª–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–≤–∞ —Ä–µ–∂–∏–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±—Ä–∞–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ (–±—ã–ª–æ –≤ v8.0)
- –î–æ–±–∞–≤–∏–ª–∏ –¥–≤–∞ —Ä–µ–∂–∏–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ cosine similarity:
  - **–õ–µ–≥–∫–∏–π:** similarity ‚â• 0.3, –º–∞–∫—Å–∏–º—É–º 5 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  - **–ñ–µ—Å—Ç–∫–∏–π:** similarity ‚â• 0.5, –º–∞–∫—Å–∏–º—É–º 2 –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –ö–æ–º–∞–Ω–¥–∞ `/compare` —Ç–µ–ø–µ—Ä—å —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —ç—Ç–∏ –¥–≤–∞ —Ä–µ–∂–∏–º–∞

### 2. –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ML reranker

**–ß—Ç–æ –ø—Ä–æ–±–æ–≤–∞–ª–∏:**
1. –£—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ `@xenova/transformers` –Ω–∞ Mac
2. –°–æ–∑–¥–∞–ª–∏ –º–æ–¥—É–ª—å `reranker.js` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º cross-encoder
3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–ª–∏ –≤ `server.js` (–≤–µ—Ä—Å–∏—è 3.0)

**–ü—Ä–æ–±–ª–µ–º–∞:** 
```
Error: dims[1] must be an integer, got: undefined
```

Feature-extraction pipeline –∏–∑ @xenova/transformers –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è reranking –∑–∞–¥–∞—á.

**–ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
- –û—Ç–∫–∞–∑–∞–ª–∏—Å—å –æ—Ç ML reranker
- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –ø–æ—Ä–æ–≥—É similarity
- –≠—Ç–æ –±—ã—Å—Ç—Ä–µ–µ, –ø—Ä–æ—â–µ –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è —Ç–µ–∫—É—â–∏—Ö –∑–∞–¥–∞—á

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

**–ù–∞ Mac (ollama-mcp):**
```
~/mcp-servers/ollama-mcp/
‚îú‚îÄ‚îÄ server.js                    # v3.1 —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ similarity
‚îú‚îÄ‚îÄ create_vector_store_v2.js    # –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è vector store
‚îî‚îÄ‚îÄ reranker.js                  # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏)
```

**–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (telegram-bot):**
```
/root/telegram-bot/
‚îú‚îÄ‚îÄ config.py                    # –î–æ–±–∞–≤–ª–µ–Ω RAG_TOP_K_INITIAL = 10
‚îú‚îÄ‚îÄ mcp_clients/
‚îÇ   ‚îî‚îÄ‚îÄ ollama_client.py        # –ü–µ—Ä–µ–¥–∞–µ—Ç VECTOR_STORE_DIR —á–µ—Ä–µ–∑ SSH
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îî‚îÄ‚îÄ rag_compare.py          # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ light vs strict
‚îî‚îÄ‚îÄ utils/
    ‚îî‚îÄ‚îÄ rag_functions.py        # get_rag_answer —Å rerank_mode
```

### 4. –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è vector stores

**–ü—Ä–æ–±–ª–µ–º–∞:** Vector store —Ç–µ—Ä—è–ª—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ Mac (–±—ã–ª –≤ /tmp)

**–†–µ—à–µ–Ω–∏–µ:**
```bash
mkdir -p ~/vector_stores
export VECTOR_STORE_DIR=~/vector_stores
```

–¢–µ–ø–µ—Ä—å –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞–º–∏.

---

## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã `/compare`

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞** –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** –∫ MCP Ollama:
   - –û–¥–∏–Ω —Å `rerank_mode: 'light'`
   - –î—Ä—É–≥–æ–π —Å `rerank_mode: 'strict'`
3. **–í MCP Ollama** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:
   - –°–æ–∑–¥–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ `nomic-embed-text`
   - –í—ã—á–∏—Å–ª–µ–Ω–∏–µ cosine similarity —Å–æ –≤—Å–µ–º–∏ —á–∞–Ω–∫–∞–º–∏
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é similarity
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ—Ä–æ–≥—É:
     - Light: similarity ‚â• 0.3, —Ç–æ–ø-5
     - Strict: similarity ‚â• 0.5, —Ç–æ–ø-2
   - –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∞–Ω–∫–æ–≤
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ `llama3.2:3b`
4. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞** —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏:
   - –û–±–∞ –æ—Ç–≤–µ—Ç–∞
   - –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Å similarity scores
   - –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–ª–∏—á–∏–π

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç MCP Ollama

```json
{
  "query": "–ö–∞–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –µ—Å—Ç—å —É –±–æ—Ç–∞?",
  "answer": "...",
  "sources": [
    {
      "text": "# Telegram –±–æ—Ç...",
      "similarity": 0.804,
      "index": 0
    }
  ],
  "model": "llama3.2:3b",
  "context_length": 1234,
  "chunks_used": 5,
  "rerank_mode": "light",
  "reranked": true
}
```

### –ú–µ—Ç—Ä–∏–∫–∏ –≤ –æ—Ç–≤–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

```
üìä –ê–ù–ê–õ–ò–ó –†–ê–ó–õ–ò–ß–ò–ô:
‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–æ–≤: 5 vs 2 (—Ä–∞–∑–Ω–∏—Ü–∞: 3)
‚Ä¢ –°—Ä–µ–¥–Ω–∏–π similarity (–ª–µ–≥–∫–∏–π): 0.769
‚Ä¢ –°—Ä–µ–¥–Ω–∏–π similarity (–∂–µ—Å—Ç–∫–∏–π): 0.779
‚Ä¢ –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: 282 vs 374 —Å–∏–º–≤–æ–ª–æ–≤
```

---

## üîß –§–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ GitHub

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã:

1. **README.md** (–æ–±–Ω–æ–≤–ª–µ–Ω)
2. **config.py** (–¥–æ–±–∞–≤–ª–µ–Ω RAG_TOP_K_INITIAL)
3. **mcp_clients/ollama_client.py** (–ø–µ—Ä–µ–¥–∞—á–∞ VECTOR_STORE_DIR)
4. **handlers/rag_compare.py** (–æ–±–Ω–æ–≤–ª–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏)
5. **utils/rag_functions.py** (–ø–∞—Ä–∞–º–µ—Ç—Ä rerank_mode)
6. **MODULAR_ARCHITECTURE_SUMMARY_2024-12-24.md** (—ç—Ç–æ—Ç —Ñ–∞–π–ª)

### –§–∞–π–ª—ã –¥–ª—è Mac (ollama-mcp):

7. **server_v4_similarity_filter.js** ‚Üí –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –≤ `server.js`
8. **create_vector_store_v2.js**
9. **reranker.js** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏)

---

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã `/compare`

**–ó–∞–ø—Ä–æ—Å:** "–ö–∞–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –µ—Å—Ç—å —É –±–æ—Ç–∞?"

**–õ–µ–≥–∫–∏–π —Ñ–∏–ª—å—Ç—Ä (5 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤):**
- Similarity: 0.804, 0.753, 0.750, 0.745, 0.740
- –°—Ä–µ–¥–Ω–∏–π: 0.769
- –û—Ç–≤–µ—Ç: –∫—Ä–∞—Ç–∫–∏–π (282 —Å–∏–º–≤–æ–ª–∞)
- –í—Ä–µ–º—è: 49.61—Å

**–ñ–µ—Å—Ç–∫–∏–π —Ñ–∏–ª—å—Ç—Ä (2 –¥–æ–∫—É–º–µ–Ω—Ç–∞):**
- Similarity: 0.804, 0.753
- –°—Ä–µ–¥–Ω–∏–π: 0.779
- –û—Ç–≤–µ—Ç: —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π (374 —Å–∏–º–≤–æ–ª–∞)
- –í—Ä–µ–º—è: 63.25—Å

**–í—ã–≤–æ–¥—ã:**
- ‚úÖ –ñ–µ—Å—Ç–∫–∏–π —Ñ–∏–ª—å—Ç—Ä –∏–º–µ–µ—Ç –≤—ã—à–µ —Å—Ä–µ–¥–Ω–∏–π similarity
- ‚úÖ –õ–µ–≥–∫–∏–π —Ñ–∏–ª—å—Ç—Ä –¥–∞–µ—Ç –±–æ–ª–µ–µ –∫—Ä–∞—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã
- ‚úÖ –û–±–∞ –Ω–∞—Ö–æ–¥—è—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- ‚úÖ –†–∞–∑–Ω–∏—Ü–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞

---

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

### 1. –ù–∞ Mac

```bash
# –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
mkdir -p ~/vector_stores

# –î–æ–±–∞–≤–∏—Ç—å –≤ ~/.zshrc
echo 'export VECTOR_STORE_DIR=~/vector_stores' >> ~/.zshrc
source ~/.zshrc

# –û–±–Ω–æ–≤–∏—Ç—å ollama-mcp
cd ~/mcp-servers/ollama-mcp
cp server_v4_similarity_filter.js server.js

# –°–æ–∑–¥–∞—Ç—å vector store
VECTOR_STORE_DIR=~/vector_stores node create_vector_store_v2.js
```

### 2. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ

```bash
# –û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª—ã
cd /root/telegram-bot
git pull

# –ò–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é:
# - config.py
# - mcp_clients/ollama_client.py
# - handlers/rag_compare.py
# - utils/rag_functions.py

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
systemctl restart telegram-bot
journalctl -u telegram-bot -f
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –í Telegram
/compare –ö–∞–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –µ—Å—Ç—å —É –±–æ—Ç–∞?
/compare –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–≥–æ–¥–∞?
```

---

## üí° –ò–¥–µ–∏ –¥–ª—è –±—É–¥—É—â–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π

### 1. ML Reranker (–∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–π cross-encoder
- –ú–æ–¥–µ–ª–∏: `cross-encoder/ms-marco-MiniLM-L-6-v2` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥

### 2. –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–∞–ø—Ä–æ—Å–∞
- –ï—Å–ª–∏ –≤—Å–µ similarity < 0.5 ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–µ–≥–∫–∏–π —Ä–µ–∂–∏–º
- –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å similarity > 0.7 ‚Üí –∂–µ—Å—Ç–∫–∏–π —Ä–µ–∂–∏–º

### 3. –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥
- –ö–æ–º–±–∏–Ω–∞—Ü–∏—è similarity + BM25 –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è
- –£—á–µ—Ç –¥–ª–∏–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

### 4. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
- –î–æ–±–∞–≤–∏—Ç—å FAQ
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –æ—à–∏–±–∫–∞–º

---

## üìù Changelog

### v9.0.0 (24.12.2024)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —É–º–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è RAG (light/strict —Ä–µ–∂–∏–º—ã)
- ‚úÖ –ö–æ–º–∞–Ω–¥–∞ `/compare` —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –¥–≤–∞ —Ä–µ–∂–∏–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è vector stores (~/vector_stores)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (similarity –≤–º–µ—Å—Ç–æ rerank score)
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚ùå –û—Ç–∫–∞–∑ –æ—Ç ML reranker (–ø—Ä–æ–±–ª–µ–º—ã —Å @xenova/transformers)

### v8.0.0 (24.12.2024)
- –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –ö–æ–º–∞–Ω–¥–∞ `/compare` (RAG vs No-RAG)
- –ß–∏—Å—Ç—ã–π –∫–æ–¥ (~1000 —Å—Ç—Ä–æ–∫)

### v7.0.0 (23.12.2024)
- Ollama RAG Integration
- –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- [README.md](./README.md)
- [OLLAMA_RAG_INTEGRATION_SUMMARY.md](./OLLAMA_RAG_INTEGRATION_SUMMARY.md)
- [PROJECT_CONTEXT_UPDATED.md](./PROJECT_CONTEXT_UPDATED.md)

---

**–ê–≤—Ç–æ—Ä:** –í–∏–∫—Ç–æ—Ä –ö—É–∑—å–º–∏–Ω  
**–î–∞—Ç–∞:** 24 –¥–µ–∫–∞–±—Ä—è 2024  
**–í–µ—Ä—Å–∏—è:** 9.0.0
